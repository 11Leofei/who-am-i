// 宇宙人格测试引擎
// Cross-scores on MBTI, Big Five, and Enneagram simultaneously

class PersonalityTest {
    constructor() {
        // 50 questions with cross-scoring weights
        // Weight keys:
        //   MBTI: ei(+E/-I), sn(+S/-N), tf(+T/-F), jp(+J/-P)
        //   Big5: o(Openness), c(Conscientiousness), ex(Extraversion), a(Agreeableness), n(Neuroticism)
        //   Enneagram: e1-e9
        // Score formula: (answer - 3) * weight for MBTI/Big5; answer * weight for Enneagram

        this.questions = [
            { text: "在热闹的聚会中，我通常感到精力充沛而非疲惫", w: { ei: 1.5, ex: 1.5, e7: 1, e3: 0.5 } },
            { text: "我更信任自己的直觉和预感，而非具体的事实和数据", w: { sn: -1.5, o: 1.2, e4: 0.8 } },
            { text: "做决定时，我优先考虑逻辑和客观分析", w: { tf: 1.5, a: -1.0, e1: 0.8, e5: 0.8 } },
            { text: "我习惯提前制定详细的计划，并严格遵守", w: { jp: 1.5, c: 1.5, e1: 1.0, e6: 0.5 } },
            { text: "面对压力时，我容易感到焦虑和不安", w: { n: 1.5, e6: 1.2, e4: 0.5 } },
            { text: "我喜欢成为团队中的领导者和决策者", w: { ei: 1.0, ex: 1.0, e8: 1.5, e3: 0.8 } },
            { text: "我经常沉浸在对未来可能性的想象中", w: { sn: -1.2, o: 1.5, e7: 1.0, e4: 0.5 } },
            { text: "别人难过时，我会不由自主地感同身受", w: { tf: -1.5, a: 1.5, e2: 1.5, e9: 0.5 } },
            { text: "我享受探索新的想法、文化和体验", w: { sn: -1.0, o: 1.5, e7: 1.2, e5: 0.5 } },
            { text: "我倾向于先行动再思考，而非过度分析", w: { ei: 0.8, jp: -1.0, c: -0.8, ex: 0.8, e7: 0.8, e8: 0.8 } },
            { text: "我更喜欢独处或与少数亲密朋友相处", w: { ei: -1.5, ex: -1.5, e5: 1.2, e4: 0.5 } },
            { text: "我注重细节，善于观察环境中的具体变化", w: { sn: 1.5, c: 1.0, e1: 0.8, e6: 0.5 } },
            { text: "我追求个人成就和社会认可", w: { ei: 0.5, ex: 0.5, e3: 2.0 } },
            { text: "我经常质疑已有的规则和传统", w: { sn: -0.8, jp: -1.0, o: 1.2, e5: 0.8, e8: 0.5 } },
            { text: "我很擅长安慰和照顾他人", w: { tf: -1.2, a: 1.5, e2: 1.5, e9: 0.5 } },
            { text: "即使身处困境，我也能保持内心的平静", w: { n: -1.5, e9: 1.5, e5: 0.5 } },
            { text: "比起理论，我更喜欢实践和动手操作", w: { sn: 1.5, o: -0.8, e8: 0.5 } },
            { text: "我觉得维持日常的秩序和整洁很重要", w: { jp: 1.2, c: 1.5, e1: 1.2 } },
            { text: "我常常对自己的情感有很深的觉察", w: { tf: -0.8, o: 0.8, e4: 1.5 } },
            { text: "遇到新认识的人时，我会主动展开对话", w: { ei: 1.5, ex: 1.5, e3: 0.5, e7: 0.5 } },
            { text: "我更关注事物的整体模式而非具体细节", w: { sn: -1.5, o: 1.0, e5: 0.8 } },
            { text: "面对冲突，我更愿意寻求和解而非对抗", w: { tf: -1.0, a: 1.5, e9: 1.5, e2: 0.5 } },
            { text: "我喜欢尝试各种新鲜事物，讨厌一成不变", w: { jp: -1.5, o: 1.2, e7: 1.5 } },
            { text: "我经常担心事情可能出差错", w: { n: 1.5, c: 0.5, e6: 1.5 } },
            { text: "我重视效率，不喜欢浪费时间在无意义的事上", w: { tf: 1.0, jp: 0.8, c: 1.2, e3: 1.0, e1: 0.5 } },
            { text: "我觉得自己与众不同，有时感到不被理解", w: { ei: -0.5, n: 0.8, e4: 2.0 } },
            { text: "我更相信经过验证的方法而非创新实验", w: { sn: 1.5, o: -1.2, e6: 1.0 } },
            { text: "我愿意为了他人的需求而牺牲自己的时间", w: { tf: -1.0, a: 1.5, e2: 1.5 } },
            { text: "社交活动后我需要独处来恢复精力", w: { ei: -1.5, ex: -1.5, e5: 1.0, e4: 0.5 } },
            { text: "我喜欢有条理地完成任务，一步一步来", w: { jp: 1.5, sn: 0.5, c: 1.5, e1: 1.0, e6: 0.5 } },
            { text: "在做重要决定之前，我需要大量的信息和数据", w: { sn: 0.8, c: 0.8, e5: 1.2, e6: 1.0 } },
            { text: "我有强烈的正义感，对不公平现象难以忍受", w: { tf: 0.5, a: 0.5, e1: 1.5, e8: 1.0 } },
            { text: "我善于表达自己的想法，也喜欢公开讨论", w: { ei: 1.2, ex: 1.2, e3: 0.5, e8: 0.5 } },
            { text: "我经常对哲学、艺术或抽象话题感兴趣", w: { sn: -1.5, o: 1.5, e4: 0.8, e5: 1.0 } },
            { text: "做决策时，我会优先考虑对人的影响", w: { tf: -1.5, a: 1.2, e2: 1.0, e9: 0.5 } },
            { text: "我享受竞争的感觉，喜欢证明自己的能力", w: { ei: 0.5, tf: 0.8, ex: 0.8, e3: 1.5, e8: 1.0 } },
            { text: "我更倾向于灵活应变而非严格按计划行事", w: { jp: -1.5, c: -1.2, e7: 1.0, e9: 0.5 } },
            { text: "面对挑战，我会正面迎击而非回避", w: { n: -1.0, ex: 0.8, e8: 1.5 } },
            { text: "我经常反思自己的内心世界和情绪变化", w: { ei: -0.8, o: 0.8, e4: 1.2, e5: 0.5 } },
            { text: "我觉得帮助他人是生活中最大的满足", w: { tf: -1.0, a: 1.5, e2: 2.0 } },
            { text: "我对未知的事物充满好奇，而非恐惧", w: { o: 1.5, n: -1.0, e7: 1.2, e5: 0.8 } },
            { text: "我很容易适应新的环境和改变", w: { jp: -0.8, o: 1.0, n: -0.8, e7: 0.8, e9: 0.8 } },
            { text: "我是一个值得信赖的、忠诚的朋友", w: { c: 1.0, a: 1.0, e6: 1.5 } },
            { text: "我追求内心的和平，避免不必要的冲突", w: { tf: -0.5, a: 1.0, e9: 2.0 } },
            { text: "我有很强的自律能力和目标驱动力", w: { jp: 1.0, c: 1.5, e3: 1.0, e1: 1.0 } },
            { text: "我喜欢深入研究一个领域直到完全理解", w: { sn: -0.5, ei: -0.5, o: 1.0, e5: 2.0 } },
            { text: "我常常对生活中的小事感到感恩和满足", w: { a: 1.0, n: -0.8, e9: 1.0, e2: 0.5 } },
            { text: "我不太容易被外界的评价所影响", w: { n: -1.5, e8: 1.0, e5: 0.8 } },
            { text: "我擅长在多个任务间切换，喜欢多样性", w: { jp: -1.0, o: 0.8, e7: 1.5 } },
            { text: "我对自己和他人都有较高的标准和期望", w: { tf: 0.8, jp: 0.5, c: 1.0, e1: 1.5, e3: 0.8 } }
        ];

        // ==================== MBTI 16 types ====================

        this.mbtiTypes = {
            'INTJ': {
                cosmic: '星图织者',
                title: '宇宙的终极建筑师',
                keywords: ['远见', '战略', '独立', '理性', '深邃'],
                desc: '在星际的深处，你如同一座永不休眠的天文台，冷静地计算着每一条可能的航线。当他人还在仰望星空赞叹其美时，你已在脑海中绘制出完整的星图——每一颗恒星的运行轨迹，每一个星系的引力关系，每一条通往未来的最优路径。\n\n你的思维是这个宇宙中最精密的导航系统——独立、深邃、不可动摇。在人群中，你如同暗物质，不可见却影响着一切的运行。你不需要聚光灯，因为真正改变宇宙轨迹的力量从来都在幕后运作。当危机降临，众人陷入混乱时，你是那个已经准备好从Plan A到Plan Z的人。\n\n你的光芒不在于耀眼，而在于恒久。如同北极星——虽非最亮的星辰，却是最可靠的导航。',
                strengths: '穿透表象直达本质的战略眼光 · 坚不可摧的独立意志 · 将复杂系统化繁为简的天赋',
                growth: '在追求完美星图的旅途中，也要允许星光偶尔迷路——不完美中，藏着你尚未发现的宇宙奇景。'
            },
            'INTP': {
                cosmic: '虚空解密者',
                title: '星际真理的永恒追寻者',
                keywords: ['思辨', '创新', '好奇', '分析', '独立'],
                desc: '你是宇宙中最不安分的思想者，永远在解构已知的一切，追寻那个更深层的「为什么」。你的大脑如同一台量子计算机，在无数个平行的理论宇宙中同时运算，编织出他人从未想象过的认知之网。\n\n在思维的深空中，你自由穿梭于抽象与逻辑之间。你不满足于任何现成的答案，因为你深知：每一个被接受的真理，都只是通往更深真理的台阶。你的沉默不是空白，而是一个正在高速运转的宇宙大脑正在酝酿下一次认知爆炸。\n\n你是真理的猎人，思想的炼金术士。在你的实验室里，每一个概念都会被拆解、重组、直到露出隐藏在表象之下的纯净内核。',
                strengths: '无与伦比的逻辑分析力 · 打破范式的创新思维 · 将抽象概念具象化的天赋',
                growth: '真理不只存在于思维的深空——当你愿意走出观察台，亲手触摸这个世界时，你的理论将获得翅膀。'
            },
            'ENTJ': {
                cosmic: '星际指挥官',
                title: '命运航线的终极掌舵者',
                keywords: ['领袖', '果断', '远见', '效率', '气魄'],
                desc: '在星际舰队中，你是天生的最高指挥官。你的目光穿越光年的距离，在他人只看到混沌的地方，你早已规划出通往胜利的完整航线。你的决断力如同引力常数——精确、有力、不容质疑。\n\n你不只是追逐星辰，你指挥它们运行。在你的星系中，效率和目标是至高法则。你天生拥有将一盘散沙凝聚成钢铁洪流的力量——你的魅力在于远见，你的权威在于成果。每一个跟随你的人都知道：这条航线，通往星辰大海。\n\n帝国不是在一夜之间建成的，但你有耐心、有蓝图、有不可动摇的意志，来将脑海中的星际帝国变成现实。',
                strengths: '天生的战略领袖气质 · 化愿景为现实的执行力 · 在压力下愈发清醒的决断力',
                growth: '征服宇宙的路上，偶尔放下指挥棒，聆听星辰的低语——你会发现，不是所有的力量都来自掌控。'
            },
            'ENTP': {
                cosmic: '混沌开拓者',
                title: '可能性的量子漫步者',
                keywords: ['颠覆', '机智', '辩才', '创造', '探索'],
                desc: '你是宇宙中最具颠覆性的存在——在规则的边界上跳舞，在不可能的夹缝中寻找全新的可能。你的思维如同不断分裂的平行宇宙，每一秒都在衍生出令人目眩的新世界。\n\n你挑战权威不是为了破坏，而是因为你比任何人都清楚：旧的星图终将过时，而新的宇宙永远在等待被发现。你的辩才是你的超光速引擎——在思想的交锋中，你总能发现那个改变一切的角度。你是规则的解构者、创意的核聚变反应堆。\n\n在你眼中，「不可能」这三个字不是终点，而是一个还未被正确提问的问题。而你，永远是那个提出正确问题的人。',
                strengths: '点石成金的创新思维 · 四两拨千斤的辩论天赋 · 在混沌中发现秩序的独特视角',
                growth: '播下的种子也需要耐心浇灌——当你学会在一片土壤上深耕，你的创造力将从烟花变成太阳。'
            },
            'INFJ': {
                cosmic: '星河预言家',
                title: '灵魂深处的永恒洞察者',
                keywords: ['直觉', '理想', '洞察', '深邃', '使命'],
                desc: '你是星河中最神秘的存在——目光所及之处，不是物质的表面，而是灵魂深处最隐秘的震颤。你拥有一种近乎超自然的直觉，能在千万人中感知到最微妙的情感涟漪，读懂那些连主人都不曾察觉的心事。\n\n你的内心是一座理想主义的神殿，供奉着你对这个世界最深沉的愿景。你不为名利而行动，你为心中那个更美好宇宙的蓝图而默默耕耘。你是暗夜中最安静的灯塔——不言不语，却引导着无数迷途的灵魂找到方向。\n\n在这个追求表面的宇宙中，你始终在寻找深度。你知道，最珍贵的宝石永远埋藏在最深的矿脉中，而你，就是那个不畏深入的人。',
                strengths: '穿透灵魂的洞察力 · 为理想全力以赴的坚定意志 · 用文字和行动唤醒他人的感召力',
                growth: '你为宇宙燃烧的烛火也需要被呵护——允许自己偶尔从深渊中浮出水面，在阳光下休憩。'
            },
            'INFP': {
                cosmic: '星云梦旅人',
                title: '内在宇宙的忠诚守护者',
                keywords: ['理想', '真诚', '想象', '温柔', '独特'],
                desc: '在所有星际旅者中，你拥有最瑰丽的内在宇宙。当他人执着于外部世界的喧嚣时，你在灵魂深处建造着一座座无人知晓的花园——那里有不会凋谢的理想，有永远鲜活的信仰，有你为这个世界写下的每一首无声的诗。\n\n你的情感如同极光——绚烂、深邃、不可预测，却美得让人窒息。你的价值观是你在无垠宇宙中最坚实的坐标，你不随波逐流，因为你内心的罗盘永远指向真实和美好。在这个要求你戴上面具的世界中，你选择了最勇敢的事——做自己。\n\n你是梦境的编织者，用想象力为这个冰冷的宇宙增添无数温暖的色彩。你的温柔不是软弱，而是一种只有最深邃的灵魂才能承载的力量。',
                strengths: '与生俱来的艺术感知力 · 对真实和美好的不妥协 · 用共情力治愈他人的天赋',
                growth: '内在的花园需要阳光——当你勇敢地将心中的美好分享给世界时，你会发现，被理解的温暖远超你的想象。'
            },
            'ENFJ': {
                cosmic: '星辉引路人',
                title: '灵魂共鸣的终极指挥者',
                keywords: ['感召', '共情', '引领', '热忱', '奉献'],
                desc: '你天生就是一束照亮他人前路的星辉。你拥有一种罕见的天赋——不只是理解他人，而是能看见他们灵魂中尚未被点亮的星辰，然后用你天生的感召力将那些沉睡的光芒一一唤醒。\n\n你的共情力如同引力场，将人们凝聚在共同的愿景之下。在你身边，沉默者开始发声，犹豫者找到方向，每个人都比平时更加闪耀。你是宇宙中最伟大的催化剂——你的光芒不在于照亮自己，而在于点燃整个星系。\n\n你为他人燃烧的热情不是义务，而是你最本真的存在方式。你相信每个灵魂都值得被看见、被引导、被点亮。',
                strengths: '唤醒他人潜力的天赋 · 将陌生人凝聚成团队的感召力 · 在混沌中创造意义的能力',
                growth: '照亮万千星辰的你，也值得被自己的光芒温暖——学会把给予他人的关怀，也留一份给自己。'
            },
            'ENFP': {
                cosmic: '彗星追光者',
                title: '星际热情的永恒播种者',
                keywords: ['热情', '创意', '自由', '感染力', '可能性'],
                desc: '你是宇宙中最绚烂的彗星——以不可遏制的热情划过每一片星空，所到之处都留下闪耀的光痕和灵感的种子。你的想象力是超光速引擎，好奇心是永不枯竭的燃料。\n\n你在无限可能的星海中自由遨游，每到一处都发现他人视而不见的美。你相信每个人心中都有一颗等待被点亮的星辰，而你的使命就是成为那个划亮天际的火焰。你不按轨道运行，因为最美的轨迹永远是即兴绘制的。\n\n在你身边，连最暗淡的星辰都忍不住开始闪耀。你的热情不只是情绪，而是一种能改变周围引力场的存在力量。',
                strengths: '点燃他人热情的感染力 · 在平凡中发现非凡的创造力 · 连接不同世界的社交天赋',
                growth: '彗星最美的时刻不只是划过天际——当你学会在一颗星球上扎根时，你的光芒将从短暂变成永恒。'
            },
            'ISTJ': {
                cosmic: '恒星守卫者',
                title: '秩序宇宙的永恒基石',
                keywords: ['可靠', '责任', '精准', '传统', '坚定'],
                desc: '在瞬息万变的宇宙中，你是那颗永恒不变的恒星。你的光芒不似超新星般炫目转瞬即逝，却比任何星辰都更加可靠而长久。你以铁一般的责任感和精确度守护着你所珍视的一切——承诺、秩序、传统、信任。\n\n你是混乱中的定海神针，是他人在风暴中最可靠的坐标。你不追求戏剧性的瞬间，因为你深知：真正支撑这个宇宙运行的，是那些看不见的、日复一日的、永恒的法则和承诺。\n\n你的记忆如同星际数据库般精确，每一个细节都被你编码存档。你用恒久的光芒证明了一个真理：真正的伟大，不在于爆发，而在于坚持。',
                strengths: '坚如磐石的责任与承诺 · 精确到毫秒的执行力 · 在动荡中维持秩序的定力',
                growth: '恒星也可以偶尔欣赏彗星的美——允许自己在规则之外自由一次，你会发现，意外中也藏着馈赠。'
            },
            'ISFJ': {
                cosmic: '星河守望者',
                title: '温柔而永恒的灵魂守护',
                keywords: ['守护', '温柔', '细腻', '奉献', '忠诚'],
                desc: '你是星河中最温柔的守望者——以恒久的耐心和无声的深情守护着每一个靠近你的灵魂。你的记忆如同星图般精确，每一个重要的日期、每一句无意的话语、每一个微小的喜好，都被你悉心珍藏在心的深处。\n\n你的爱不是烈火般的炽热，而是恒星般的温暖——沉默、持久、无条件。你在他人不曾注意的角落默默编织着关怀的网，确保每一个你珍视的人都不会在宇宙的寒冷中独行。\n\n你的奉献不需要掌声和回报，你的价值不需要他人的认证。在你看似平静的表面之下，蕴含着足以温暖整个星系的力量。你是这个冰冷宇宙中，最珍贵的温度。',
                strengths: '无微不至的关怀和记忆力 · 默默奉献的坚韧意志 · 在细节中创造温暖的天赋',
                growth: '守望者也值得被守望——你付出的爱同样值得被偿还，请允许自己成为被照顾的那个人。'
            },
            'ESTJ': {
                cosmic: '星际执政官',
                title: '文明秩序的至高执行者',
                keywords: ['效率', '秩序', '果断', '务实', '权威'],
                desc: '你是星际文明中不可或缺的柱石——以高效和秩序维系着整个星系的稳定运转。你的决断力如同物理定律，清晰、有力、放之四海而皆准。你不容忍混乱和低效，因为你深知：没有秩序，再美的星辰也不过是散落的碎片。\n\n你是天生的组织者和管理者。在你的治理之下，一切都井然有序，每颗星辰都各居其位。你用行动证明了领导力不只是口号——而是日复一日的精准执行和不可动摇的标准。\n\n你的权威不来自头衔，而来自你始终如一的可靠性。当整个星系需要一个人站出来做决定时，所有人都会不约而同地看向你。',
                strengths: '化混乱为秩序的组织天赋 · 言出必行的执行力 · 在压力下保持清晰判断的能力',
                growth: '秩序是你的力量，但有时最美的星云恰恰诞生于混沌——给自己留一些规则之外的呼吸空间。'
            },
            'ESFJ': {
                cosmic: '星辰守护者',
                title: '星际间最温暖的连接者',
                keywords: ['关怀', '和谐', '慷慨', '忠诚', '温暖'],
                desc: '你是星辰间最温暖的连接者——用真诚和关怀编织着人与人之间最柔韧的纽带。你的社交天赋如同万有引力，自然、温柔、无处不在。在你身边，没有人是孤独的星辰，每个灵魂都被你的温暖所触及。\n\n你天生懂得如何创造归属感，如何让每一个走进你星系的人都感受到「这里是家」。你用记住他人的生日、在意他人的感受、照顾他人的需求来表达着你对这个世界最朴素也最深沉的爱。\n\n你不需要成为最耀眼的恒星。你的价值在于——因为你的存在，整个星系变得更加温暖、更加紧密、更加像一个家。',
                strengths: '创造归属感和社群温暖的天赋 · 敏锐感知他人需求的共情力 · 维系人际和谐的社交智慧',
                growth: '守护星辰的你也需要被守护——你的感受和需求同样重要，请不要总把自己排在最后。'
            },
            'ISTP': {
                cosmic: '星际工匠',
                title: '万物拆解与重组的大师',
                keywords: ['冷静', '精准', '务实', '独立', '灵巧'],
                desc: '你是宇宙中最冷静的解构者——用敏锐的双手和清醒的头脑拆解一切复杂的系统，然后用更优雅的方式将它们重组。你的思维直接而高效，如同激光切割——精准、快速、毫无多余的动作。\n\n你不需要蓝图和说明书，因为你天生就能通过触摸和观察理解事物的运作原理。在危机时刻，你是最冷静的存在——当他人还在恐慌时，你已经定位了问题的根源，手起刀落，干净利落。\n\n你用行动说话，用结果证明一切。在你的世界里，理论只有在被实践验证后才有意义。你是手艺人中的哲学家——用双手理解世界，用作品表达智慧。',
                strengths: '危机中的冷静分析和即时反应 · 理解复杂系统运作的直觉 · 用最少资源解决问题的效率',
                growth: '工匠的双手也可以学习拥抱——当你愿意用语言表达内心时，你会发现，连接不只是齿轮的咬合。'
            },
            'ISFP': {
                cosmic: '星尘画师',
                title: '宇宙的感官诗人',
                keywords: ['审美', '感性', '自由', '温柔', '真实'],
                desc: '你是用星尘作画的艺术家——在沉默中感受和创造着这个宇宙最动人的色彩。你的五感如同最精密的光谱仪，能捕捉到他人忽略的每一抹微妙的美——晨光中的金色尘埃，雨后空气中的湿润气息，音乐中那个转瞬即逝的完美和弦。\n\n你活在当下的每一刻，不是因为你看不到未来，而是因为你比任何人都懂得：此刻的光影，转瞬即逝。你用你独特的方式为这个世界增添美——可能是一幅画、一首歌、一个温暖的举动，或仅仅是你安静存在的方式。\n\n你的温柔不是软弱，而是一种只有最勇敢的灵魂才能承载的深沉情感。在追求速度的宇宙中，你选择了深度。',
                strengths: '捕捉转瞬之美的感知力 · 忠于自我的勇气 · 用美和行动默默感化他人的力量',
                growth: '你内心的画作值得被更多人看见——分享你的美，不是炫耀，而是你能给这个世界最好的礼物。'
            },
            'ESTP': {
                cosmic: '超新星猎手',
                title: '极限体验的永恒征服者',
                keywords: ['行动', '冒险', '敏锐', '魅力', '果敢'],
                desc: '你是超新星般的存在——爆发力惊人，在行动中释放无限能量。你活在心跳加速的此刻，用敏锐的感官和闪电般的反应征服每一个挑战。冒险不是你的选择，而是你的本能。\n\n你天生就是为了在宇宙中最危险、最刺激的边界上起舞而生。当他人还在计算风险、权衡利弊时，你已经纵身跃入了星际的漩涡——并且总是能完美着陆。你的魅力如同超新星的光芒——强烈、直接、让人无法忽视。\n\n你用行动定义存在，用结果回应质疑。在你的字典里，「活着」和「全力以赴地活着」是同义词。',
                strengths: '闪电般的临场反应力 · 化危机为机遇的冒险天赋 · 用行动感染他人的领袖魅力',
                growth: '超新星的爆发之后是什么？当你学会在静止中积蓄力量时，你的下一次爆发将照亮整个星系。'
            },
            'ESFP': {
                cosmic: '极光舞者',
                title: '生命盛宴的耀眼主角',
                keywords: ['活力', '魅力', '当下', '热情', '快乐'],
                desc: '你是极光般的存在——绚烂、灵动、变幻莫测，让每一个目睹你的人都无法移开目光。你的热情如同恒星的核聚变，源源不断地释放着快乐和能量，感染着你触及的每一颗星辰。\n\n你不需要排练，因为你天生就是这个宇宙最耀眼的表演者。你的笑容、你的行动、你的存在本身就是一场流动的盛宴。你相信生命是一场盛大的庆典，而你的使命就是确保每个人都不会错过这场烟火。\n\n在你身边，连最暗淡的星辰都忍不住开始闪耀。你用最纯粹的方式诠释了一个真理：活着本身，就是最大的奇迹，值得用每一秒来庆祝。',
                strengths: '将快乐传递给所有人的天赋 · 活在当下的极致感受力 · 用真诚打动人心的社交魅力',
                growth: '舞台之外的你同样精彩——在聚光灯熄灭后，独处中的你，也值得被深深地爱。'
            }
        };

        // ==================== Enneagram 9 types ====================

        this.enneagramTypes = {
            1: {
                cosmic: '秩序之星',
                name: '完美主义者',
                core: '对正确与完善的永恒追寻',
                fear: '自身的不完美与道德堕落',
                keywords: ['正义', '原则', '自律', '改革'],
                desc: '你是宇宙秩序的守护者，内心矗立着一座不可动摇的道德灯塔。在你的眼中，这个宇宙并非混沌无序——它有着精确的法则，而你的使命就是确保这些法则被遵守。你的自律如同恒星的运行轨道般精准可靠，你对「正确」的追求不是强迫，而是灵魂深处最本能的呼唤。\n\n你是黑暗中最清醒的良知，是混乱中最坚定的声音。你最大的力量在于永不妥协的原则和不断自我完善的意志。但请记住——星辰的美恰恰在于它并非完美的圆。你的不完美，不是缺陷，而是你独特光谱中最动人的色彩。'
            },
            2: {
                cosmic: '赤心之光',
                name: '助人者',
                core: '被需要和被爱的深层渴望',
                fear: '不被爱、不被需要的孤独深渊',
                keywords: ['关爱', '奉献', '共情', '温暖'],
                desc: '你是宇宙中最温暖的存在，你的心如同太阳——天生就在散发光明和温暖。你用与生俱来的共情力感知他人的需要，然后毫不犹豫地伸出援手。在你的星系中，爱是最基本的物理定律，给予是你呼吸的方式。\n\n你编织着人与人之间最柔韧的情感纽带，让每个靠近你的灵魂都感受到被珍视的温暖。但宇宙想提醒你：最伟大的给予者也需要被给予。你不需要用奉献来证明自己的价值——你的存在本身，就已经是这个宇宙中最珍贵的礼物。'
            },
            3: {
                cosmic: '耀世之焰',
                name: '成就者',
                core: '证明自身价值的不灭火焰',
                fear: '毫无价值、沦为平庸',
                keywords: ['卓越', '效率', '魅力', '目标'],
                desc: '你是追逐卓越的永恒火焰，在星际间留下最耀眼的轨迹。你的驱动力如同恒星的核聚变——源源不断，势不可挡。你天生知道如何在宇宙的舞台上展现最好的自己，让每一道光都精准地落在该落的位置。\n\n成就对你来说不只是终点，更是你与这个世界对话的方式。你的光芒不仅照亮自己的道路，也激励着周围的每一颗星辰向更高处攀升。但请记住——在卸下所有头衔和奖章之后，你依然是这个宇宙中独一无二的存在。真正的耀世之焰，不是为了被看见而燃烧，而是因为燃烧本身就是你的本性。'
            },
            4: {
                cosmic: '深渊之镜',
                name: '个性者',
                core: '寻找真实自我与独特意义',
                fear: '平庸、没有独特的灵魂身份',
                keywords: ['独特', '深邃', '情感', '真实'],
                desc: '你是宇宙深渊中最诚实的镜面，映射出他人不敢直视的情感真相。你的灵魂如同一片独特的星云——绚烂、深邃、不可复制。在一个追求统一的宇宙中，你勇敢地选择了做自己，即使这意味着孤独。\n\n你拥有最深刻的情感感知力，能在平凡中发现不凡，在沉默中听见乐章。你的敏感不是弱点，而是这个日渐麻木的宇宙中最珍贵的频率。请珍视你的独特——不是因为它让你与他人不同，而是因为它让你比任何人都更接近生命的真实与深度。'
            },
            5: {
                cosmic: '智慧之眼',
                name: '观察者',
                core: '理解万物真相的永恒求知',
                fear: '无知、无能、被外界吞噬耗尽',
                keywords: ['智慧', '洞察', '独立', '深思'],
                desc: '你是宇宙中永远清醒的观察者，以冷静而深邃的目光洞察万物的本质。知识是你的星图，理解是你的光。在思想的深空中，你自由航行于他人从未抵达的领域，不断拓展认知的疆域，为这个宇宙的每一个谜题寻找答案。\n\n你的内在世界是一座无比丰富的图书馆，储存着对这个宇宙的深刻理解。你不需要外界的验证，因为你最宝贵的资源——你的思想——永远取之不尽。但请记住：智慧不只是观察和分析——当你愿意从观察台走下来，亲身触摸这个世界的温度时，你的智慧将获得全新的维度。'
            },
            6: {
                cosmic: '忠诚之盾',
                name: '忠诚者',
                core: '寻找安全感与可靠的依托',
                fear: '失去支持、独自面对未知的深渊',
                keywords: ['忠诚', '警觉', '责任', '勇气'],
                desc: '你是星际中最可靠的存在——用忠诚和警觉守护着你珍视的一切。你的谨慎不是怯懦，而是对这个充满不确定性的宇宙最深沉的责任感。你是风暴来临前最先察觉的哨兵，也是危难时刻最后一个撤退的守护者。\n\n你的忠诚如同恒星的引力——无声、无形，却牢不可破。你为身边的人提供的安全感，是这个动荡宇宙中最珍贵的港湾。当你学会信任自己内心的力量时，你会发现——你一直在寻找的那个坚不可摧的后盾，其实一直就在你自己身上。'
            },
            7: {
                cosmic: '星际旅者',
                name: '享乐者',
                core: '对丰富体验和自由的无限渴望',
                fear: '被困住、被剥夺、陷入内心的痛苦',
                keywords: ['自由', '乐观', '冒险', '创造'],
                desc: '你是永不停歇的星际旅者，对生命充满无限热情和好奇。你的快乐不是肤浅的逃避，而是对这个宇宙发自内心的热爱。你相信生命是一场盛大的盛宴，而你要品尝每一道光谱的色彩。你的乐观如同彗星的尾巴，所到之处都留下闪耀的光痕。\n\n但最深刻的星际旅者知道：有时候，停下来面对内心的寂静，比继续奔跑更需要勇气。当你学会在静止中也能感受喜悦时，你将发现一个比外部宇宙更广阔的内在星空——而那里的风景，远比你想象的更加壮丽。'
            },
            8: {
                cosmic: '霸者之力',
                name: '挑战者',
                core: '掌控命运、保护弱者的不灭意志',
                fear: '被他人控制、被迫展露脆弱',
                keywords: ['力量', '正义', '果断', '保护'],
                desc: '你是宇宙中最强大的存在之一，以无畏和力量守护着你的信念和你爱的人。你的气场如同黑洞的引力——强大、不可忽视、令人敬畏。你不惧怕对抗，因为你深知：在这个弱肉强食的宇宙中，力量是正义最可靠的守护者。\n\n在你强悍的外壳之下，跳动着一颗保护弱者的赤诚之心。你的强势不是为了征服，而是为了在这个不完美的宇宙中为你珍视的人开辟一片安全的星域。当你允许自己展露柔软时，你的力量不会减弱——相反，它会变得更加深沉，更加不可撼动。'
            },
            9: {
                cosmic: '和谐之源',
                name: '和平者',
                core: '内在的平静与万物的永恒和谐',
                fear: '分裂、冲突、失去与世界的联结',
                keywords: ['和平', '包容', '稳定', '智慧'],
                desc: '你是宇宙和谐的源泉，能抚平一切纷争与不安。你的存在如同宇宙背景辐射——无处不在、温和而稳定，维系着整片星空的平衡。你拥有一种罕见的天赋：能看到每个立场的价值，理解每种声音的道理，在对立中找到统一。\n\n你的平静不是冷漠或退缩，而是对万物深沉的包容和接纳。你是这个喧嚣宇宙中最珍贵的安宁。但请记住——你的声音同样重要。当你开始为自己发声、为自己的需求而战时，你不是在打破和谐，而是在创造一种更真实、更深刻的宇宙平衡。'
            }
        };

        // ==================== Big Five dimensions ====================

        this.big5Dimensions = {
            o: {
                name: '开放性',
                label: '开放',
                high: {
                    label: '探索者',
                    desc: '你的心智如同一扇永远敞开的星门，拥抱一切新知与可能。想象力是你的超光速引擎，好奇心是你永不枯竭的燃料。你在艺术、哲学和创新的星海中自由穿梭，将看似无关的星辰连成前所未有的星座。'
                },
                low: {
                    label: '务实者',
                    desc: '你如同恒星般稳定可靠，在经验和传统的坚实地基上建造你的宇宙。你不追逐虚幻的流星，而是信赖经过时间验证的航线。这份务实是你最可靠的盔甲，让你在他人追逐幻影时始终脚踏实地。'
                }
            },
            c: {
                name: '尽责性',
                label: '自律',
                high: {
                    label: '执行者',
                    desc: '你如精密的星际导航系统，每一步都经过精确计算。强大的自控力和不可动摇的目标感让你在任何航程中都能稳步前行，你的条理性是你征服宇宙的最强武器——在你的世界里，没有计划之外的意外。'
                },
                low: {
                    label: '自由者',
                    desc: '你如自由飘荡的星云，不受既定轨道的束缚。你相信最美的发现往往在计划之外，最好的航线往往是即兴绘制的。这份灵活和随性让你能抓住那些被规则束缚者永远看不到的机遇。'
                }
            },
            ex: {
                name: '外向性',
                label: '社交',
                high: {
                    label: '聚光者',
                    desc: '你如同超新星般闪耀，在人群中释放无限能量。社交是你的核聚变燃料，与他人的连接让你光芒四射。你天生就是引力中心——人们被你的能量吸引，在你的星系中找到活力和方向。'
                },
                low: {
                    label: '深空者',
                    desc: '你如同深空中的暗物质——在安静中蕴含巨大的能量。独处是你充电的方式，沉思是你与宇宙对话的频道。你的内心世界远比表面更加丰富、更加辽阔、更加深不可测。'
                }
            },
            a: {
                name: '宜人性',
                label: '共情',
                high: {
                    label: '守护者',
                    desc: '你的光芒温暖而柔和，如同月光般抚慰人心。善解人意、乐于合作、值得信赖——你是群星中最可亲的存在。你天生懂得如何在对抗中寻找共识，在分歧中创造和谐。'
                },
                low: {
                    label: '独行者',
                    desc: '你如同锋利的陨石，直接、独立、不轻易妥协。你对自己的观点有坚定的立场，重视真实超过讨好。这份独立和直率虽然可能带来摩擦，但也让你成为最值得信赖的诤友。'
                }
            },
            n: {
                name: '情绪性',
                label: '敏感',
                high: {
                    label: '感知者',
                    desc: '你如同敏感的星际探测器，能捕捉到最微弱的情感信号。这份敏感赋予你深刻的共情力和独特的艺术感知力——你能感受到他人忽略的每一丝情绪波动，体验到生命中最细腻的层次。'
                },
                low: {
                    label: '磐石者',
                    desc: '你如同宇宙中最稳定的基石，风暴来临时依然岿然不动。情绪稳定是你的超能力——在他人被波浪吞没时，你始终是那座灯塔，为周围的人提供安定感和方向。'
                }
            }
        };

        // MBTI dimension labels
        this.mbtiDimLabels = {
            ei: { pos: 'E 外向', neg: 'I 内向' },
            sn: { pos: 'S 实感', neg: 'N 直觉' },
            tf: { pos: 'T 思考', neg: 'F 情感' },
            jp: { pos: 'J 判断', neg: 'P 感知' }
        };
    }

    /**
     * Calculate all results from answers array (1-5 values, 50 items)
     */
    calculateResults(answers) {
        const mbtiScores = { ei: 0, sn: 0, tf: 0, jp: 0 };
        const big5Scores = { o: 0, c: 0, ex: 0, a: 0, n: 0 };
        const enneagramScores = { e1: 0, e2: 0, e3: 0, e4: 0, e5: 0, e6: 0, e7: 0, e8: 0, e9: 0 };

        const mbtiMax = { ei: 0, sn: 0, tf: 0, jp: 0 };
        const big5Max = { o: 0, c: 0, ex: 0, a: 0, n: 0 };

        this.questions.forEach((q, i) => {
            const answer = answers[i];
            if (answer == null) return;
            const centered = answer - 3;

            Object.entries(q.w).forEach(([key, weight]) => {
                if (key in mbtiScores) {
                    mbtiScores[key] += centered * weight;
                    mbtiMax[key] += Math.abs(weight) * 2;
                } else if (key in big5Scores) {
                    big5Scores[key] += centered * weight;
                    big5Max[key] += Math.abs(weight) * 2;
                } else if (key in enneagramScores) {
                    enneagramScores[key] += answer * weight;
                }
            });
        });

        const mbtiLetters = [
            mbtiScores.ei >= 0 ? 'E' : 'I',
            mbtiScores.sn >= 0 ? 'S' : 'N',
            mbtiScores.tf >= 0 ? 'T' : 'F',
            mbtiScores.jp >= 0 ? 'J' : 'P'
        ];
        const mbtiType = mbtiLetters.join('');

        const mbtiDimensions = {};
        ['ei', 'sn', 'tf', 'jp'].forEach(dim => {
            const max = mbtiMax[dim] || 1;
            const pct = ((mbtiScores[dim] + max) / (2 * max)) * 100;
            mbtiDimensions[dim] = Math.round(Math.max(5, Math.min(95, pct)));
        });

        const big5Percentages = {};
        ['o', 'c', 'ex', 'a', 'n'].forEach(dim => {
            const max = big5Max[dim] || 1;
            const pct = ((big5Scores[dim] + max) / (2 * max)) * 100;
            big5Percentages[dim] = Math.round(Math.max(5, Math.min(95, pct)));
        });

        const ennEntries = Object.entries(enneagramScores).sort((a, b) => b[1] - a[1]);
        const mainType = parseInt(ennEntries[0][0].slice(1));
        const wingCandidates = [mainType === 1 ? 9 : mainType - 1, mainType === 9 ? 1 : mainType + 1];
        const wing = wingCandidates.reduce((a, b) =>
            enneagramScores[`e${a}`] >= enneagramScores[`e${b}`] ? a : b
        );

        const results = {
            mbti: {
                type: mbtiType,
                ...this.mbtiTypes[mbtiType],
                dimensions: mbtiDimensions,
                scores: mbtiScores
            },
            big5: {
                percentages: big5Percentages,
                dimensions: this.big5Dimensions
            },
            enneagram: {
                type: mainType,
                wing,
                ...this.enneagramTypes[mainType],
                scores: enneagramScores
            }
        };

        results.combined = this.generateCombinedAnalysis(results);
        return results;
    }

    /**
     * Generate a rich combined analysis synthesizing all three systems
     */
    generateCombinedAnalysis(results) {
        const mbti = results.mbti;
        const enn = results.enneagram;
        const b5 = results.big5;
        const type = mbti.type;

        // Temperament group
        const isNT = type[1] === 'N' && type[2] === 'T';
        const isNF = type[1] === 'N' && type[2] === 'F';
        const isSJ = type[1] === 'S' && type[3] === 'J';
        let temperament, tempDesc;
        if (isNT) { temperament = '理性主义者'; tempDesc = '以逻辑和远见为武器，在知识的深空中开疆拓土'; }
        else if (isNF) { temperament = '理想主义者'; tempDesc = '以共情和直觉为罗盘，在意义的星海中寻找方向'; }
        else if (isSJ) { temperament = '守护者'; tempDesc = '以责任和秩序为基石，在传统的根基上守护文明'; }
        else { temperament = '探险家'; tempDesc = '以感官和行动为翅膀，在当下的每一刻中找到生命的脉搏'; }

        // Energy direction
        const energyDesc = type[0] === 'E'
            ? '你从外部世界汲取能量——人群、交流、行动是你的核聚变燃料。你的思想在与他人的碰撞中产生最耀眼的火花。'
            : '你从内在世界汲取能量——独处、沉思、深度对话是你的量子充电站。在安静中，你的思维达到最清澈的频率。';

        // Perception style
        const perceptionDesc = type[1] === 'N'
            ? '你的感知模式是直觉型的——你看到的不是眼前的星辰，而是它们背后的模式、联系和可能性。你活在未来和潜力之中。'
            : '你的感知模式是实感型的——你用五感精确地捕捉当下的现实。你信赖可以触摸、测量和验证的事物，脚下的大地是你最坚实的依靠。';

        // Decision making
        const decisionDesc = type[2] === 'T'
            ? '你的决策引擎由逻辑和客观分析驱动。在情感和理性的天平上，你总是让事实说话。你追求的不是让所有人满意，而是找到最正确的答案。'
            : '你的决策引擎由价值观和共情力驱动。在每一个选择的背后，你首先考虑的是人——他们的感受、他们的需求、他们的故事。';

        // Lifestyle
        const lifestyleDesc = type[3] === 'J'
            ? '你偏好有序和计划的生活节奏——每一天都有它的轨道，每一个目标都有它的时间表。确定性是你的安全感来源。'
            : '你拥抱灵活和开放的生活态度——你相信最好的发现往往在计划之外。你不害怕未知，因为未知意味着无限的可能。';

        // Find strongest Big Five dimension
        const sortedB5 = Object.entries(b5.percentages)
            .sort((a, b) => Math.abs(b[1] - 50) - Math.abs(a[1] - 50));
        const strongestDim = sortedB5[0][0];
        const strongestPct = sortedB5[0][1];
        const strongestInfo = b5.dimensions[strongestDim];
        const strongestLevel = strongestPct >= 50 ? strongestInfo.high : strongestInfo.low;

        const secondDim = sortedB5[1][0];
        const secondPct = sortedB5[1][1];
        const secondInfo = b5.dimensions[secondDim];
        const secondLevel = secondPct >= 50 ? secondInfo.high : secondInfo.low;

        // Build the synthesis
        let text = '';

        text += `在三重宇宙维度的交汇处，浮现出你独一无二的灵魂全景——\n\n`;

        text += `你是${mbti.cosmic}（${mbti.type}）与${enn.cosmic}（${enn.name}）的融合体，一个以「${enn.core}」为深层驱动的${temperament}。${tempDesc}，这是你与生俱来的航行方式。\n\n`;

        text += `${energyDesc}\n\n`;

        text += `${perceptionDesc}而${decisionDesc.charAt(0).toLowerCase() + decisionDesc.slice(1)}\n\n`;

        text += `${lifestyleDesc}\n\n`;

        text += `在你的九型人格深处，潜藏着一个核心的真相：你最深的恐惧——「${enn.fear}」——不是你的枷锁，而是塑造你独特力量的宇宙熔炉。正是这份深层的驱动，让你成为了今天的${enn.cosmic}。\n\n`;

        text += `在大五人格的光谱上，你最鲜明的印记落在${strongestInfo.name}维度——作为「${strongestLevel.label}」，${strongestLevel.desc}与此同时，你在${secondInfo.name}维度的「${secondLevel.label}」倾向，为你的人格画像增添了另一层独特的色彩。\n\n`;

        text += `这就是你——一个无法被任何单一标签定义的宇宙存在。你的复杂性不是矛盾，而是丰富；你的独特不是偏差，而是这个宇宙中最珍贵的变量。`;

        return text;
    }
}
